<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Test DDR</title>
<style>
    /* ... (Styles CSS non modifi√©s) ... */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial,sans-serif;background:linear-gradient(135deg,#87CEEB 0%,#E0F6FF 50%,#B0E0E6 100%);min-height:100vh;color:#333}
    .main-content{padding:50px 20px;text-align:center;max-width:1100px;margin:0 auto}
    .main-content h1{font-size:2.5rem;margin-bottom:30px;color:#2c3e50;text-shadow:0 2px 4px rgba(0,0,0,.1)}

    /* Date en haut √† gauche */
    .today-badge{position:fixed;top:16px;left:16px;z-index:120;background:rgba(255,255,255,.97);padding:10px 16px;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.12);font-weight:900;font-size:2rem;color:#2c3e50}

    /* Boutons */
    .import-btn{position:fixed;bottom:30px;left:30px;background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff;border:none;padding:12px 16px;border-radius:12px;font-size:.9rem;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;box-shadow:0 4px 15px rgba(231,76,60,.4);transition:.3s;z-index:99;width:200px;max-width:200px;min-height:56px;text-align:center}
    .import-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(231,76,60,.5)}
    .import-btn.imported{background:linear-gradient(135deg,#27ae60,#229954)}
    
    /* NOUVEAUX STYLES POUR LES DEUX BOUTONS D'ACTION */
    .action-buttons-container{position:fixed;bottom:30px;left:250px;display:flex;gap:20px;z-index:99}
    
    .save-btn-container{display:flex;flex-direction:column;align-items:center;z-index:99}
    .save-info{background:rgba(255,255,255,.95);color:#2c3e50;padding:4px 8px;border-radius:6px;font-size:.75rem;font-weight:bold;margin-bottom:5px;box-shadow:0 2px 8px rgba(0,0,0,.1);backdrop-filter:blur(10px);border:1px solid rgba(135,206,235,.3);white-space:nowrap}
    .save-btn-bottom{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;border:none;padding:12px 16px;border-radius:12px;font-size:.9rem;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;box-shadow:0 4px 15px rgba(52,152,219,.4);transition:.3s;width:200px;max-width:200px;min-height:56px;text-align:center;opacity:.5;pointer-events:none}
    .save-btn-bottom.enabled{opacity:1;pointer-events:auto}
    .save-btn-bottom.enabled:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(52,152,219,.5);background:linear-gradient(135deg,#2980b9,#1f5f8b)}
    .save-btn-bottom.saved{background:linear-gradient(135deg,#27ae60,#229954);box-shadow:0 4px 15px rgba(39,174,96,.4)}

    /* Bouton Pr√©paration */
    .prep-btn-container{display:flex;flex-direction:column;align-items:center;z-index:99}
    .prep-btn-bottom{
        background:linear-gradient(135deg,#9b59b6,#8e44ad); /* Violet */
        color:#fff;border:none;padding:12px 16px;border-radius:12px;
        font-size:.9rem;font-weight:bold;cursor:pointer;
        display:flex;align-items:center;justify-content:center;gap:6px;
        box-shadow:0 4px 15px rgba(155,89,182,.4);transition:.3s;
        width:200px;max-width:200px;min-height:56px;text-align:center;
        opacity:.5;pointer-events:none; /* Inactif par d√©faut */
    }
    .prep-btn-bottom.enabled{opacity:1;pointer-events:auto;cursor:pointer}
    .prep-btn-bottom.enabled:hover{
        transform:translateY(-2px);
        box-shadow:0 6px 20px rgba(155,89,182,.5);
        background:linear-gradient(135deg,#8e44ad,#6c3483);
    }
    
    /* MODIFICATION ICI pour rendre le bouton transparent/inactif */
    .config-btn{
        position:fixed;bottom:30px;right:30px;width:60px;height:60px;
        background:none; /* Supprime le fond */
        border:none;border-radius:50%;cursor:default; /* Change le curseur en fl√®che par d√©faut */
        box-shadow:none; /* Supprime l'ombre */
        transition:.3s;display:flex;align-items:center;justify-content:center;z-index:100;
        opacity:0.3; /* Rendre transparent */
        pointer-events:none; /* Rendre inutilisable (bloque le clic) */
    }
    
    .status-message{margin-top:20px;padding:15px;border-radius:8px;font-weight:bold;opacity:0;transition:opacity .3s}
    .status-message.show{opacity:1}
    .status-message.success{background:rgba(46,204,113,.1);color:#27ae60;border-left:4px solid #2ecc71}
    .status-message.error{background:rgba(231,76,60,.1);color:#e74c3c;border-left:4px solid #e74c3c}

    /* Modal import */
    .modal{display:none;position:fixed;z-index:1000;inset:0;background-color:rgba(0,0,0,.5);backdrop-filter:blur(5px)}
    .modal.show{display:flex;align-items:center;justify-content:center}
    .modal-content{background:rgba(255,255,255,.95);backdrop-filter:blur(15px);border-radius:20px;padding:30px;width:90%;max-width:500px;box-shadow:0 25px 50px rgba(0,0,0,.2);position:relative}
    .close{position:absolute;top:15px;right:20px;font-size:28px;font-weight:bold;cursor:pointer;color:#aaa}
    .file-drop-zone{border:2px dashed #87CEEB;border-radius:15px;padding:40px 20px;text-align:center;background:rgba(135,206,235,.05);cursor:pointer}
    .file-drop-zone p{margin:6px 0}.or-text{opacity:.8;font-style:italic}

    /* KPIs c√¥te √† c√¥te */
    .kpi-row{display:flex;gap:32px;justify-content:center;align-items:flex-end;flex-wrap:nowrap;margin-top:12px}
    .kpi2{display:none}.kpi2 .pct{font-size:1.25rem;font-weight:800}
    .kpi2 .colWrap{margin:10px auto 0;width:80px;height:220px;border-radius:8px;background:#eef2f7;box-shadow:inset 0 0 0 1px rgba(0,0,0,.08);display:flex;align-items:flex-end;justify-content:center;padding:8px;position:relative}
    .kpi2 .bar{width:40px;height:0;border-radius:6px 6px 4px 4px;background:#ccc;transition:height .6s ease,background .3s ease}
    .kpi2 .title{margin-top:6px;color:#555; font-weight: 900;} 
    
    .kpi2 .colWrap::before{content:"";position:absolute;left:6px;right:6px;height:1px;background:rgba(0,0,0,.12);bottom:calc(220px * 0.50)}
    .kpi2 .colWrap::after{content:"";position:absolute;left:6px;right:6px;height:1px;background:rgba(0,0,0,.12);bottom:calc(220px * 0.20)}
    .kpiDisc{display:none}
    
    .kpiDisc .title{margin-top:10px;color:#555; font-weight: 900;}
    
    .kpiDisc .wrap{display:flex;align-items:center;gap:18px}
    .progress-disc{width:140px;height:140px;border-radius:50%;background:conic-gradient(#27ae60 0deg,#e6eef5 0deg);display:grid;place-items:center;margin:0 auto}
    .progress-disc .inner{width:100px;height:100px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:1.4rem}
    .progress-stats{text-align:left;background:rgba(255,255,255,.97);border-radius:14px;padding:14px 16px;box-shadow:0 6px 20px rgba(0,0,0,.12);min-width:230px}
    .progress-stats .row{margin:8px 0;line-height:1.1}
    .progress-stats .label{color:#263238;font-weight:800;font-size:1.2rem}
    .progress-stats .val{font-weight:900;font-size:1.9rem}

    /* Courbe progression r√©elle */
    .chart-block{margin:28px auto 6px;background:rgba(255,255,255,.95);border-radius:14px;box-shadow:0 12px 30px rgba(0,0,0,.12);padding:12px 14px;max-width:1100px}
    .chart-title{font-weight:800;color:#2c3e50;margin-bottom:8px}
    .chart-legend{display:flex;gap:18px;justify-content:center;margin:6px 0 8px}
    .key{display:inline-flex;align-items:center;gap:6px;font-weight:700;color:#34495e}
    .dot{width:14px;height:4px;border-radius:2px;display:inline-block}
    .dot.real{background:#2ecc71}
    /* Ajout de la couleur pour la courbe th√©orique */
    .dot.planned{background:#3498db}
    svg#advChart{width:100%;height:340px;display:block}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 
</head>
<body>
<div class="today-badge" id="todayBadge">--/--/----</div>

<div class="main-content">
    <h1>Test DDR</h1>

    <div class="kpi-row">
        <div id="kpiConformite" class="kpi2">
            <div class="pct" id="kpiPct">0%</div>
            <div class="colWrap"><div class="bar" id="kpiBar"></div></div>
            <div class="title">CONFORMITE</div>
        </div>

        <div id="kpiProgression" class="kpiDisc">
            <div class="wrap">
                <div class="progress-disc" id="disc"><div class="inner" id="discPct">0%</div></div>
                <div class="progress-stats">
                    <div class="row"><span class="label">DDR total planifi√© :</span> <span class="val" id="statTotal">0</span></div>
                    <div class="row"><span class="label">Test√©s :</span> <span class="val" id="statTested">0</span></div>
                </div>
            </div>
            <div class="title">PROGRESSION</div>
        </div>
    </div>

    <div class="chart-block">
        <div class="chart-legend">
            <span class="key"><span class="dot real"></span>Progression r√©elle</span>
            <span class="key"><span class="dot planned"></span>Progression th√©orique</span>
        </div>
        <svg id="advChart" viewBox="0 0 980 340" preserveAspectRatio="xMidYMid meet"></svg>
    </div>

    <div class="status-message" id="statusMessage"></div>
</div>

<button class="import-btn" id="importBtn">Importer fichier Test DDR</button>

<div class="action-buttons-container" id="actionButtonsContainer">
    
    <div class="save-btn-container" id="saveBtnContainer">
        <div class="save-info" id="saveInfo" style="display:none;"><span id="saveDateTime"></span></div>
        <button class="save-btn-bottom" id="saveMainBtn">Sauvegarder</button>
    </div>

    <div class="prep-btn-container" id="prepBtnContainer">
        <button class="prep-btn-bottom" id="prepMainBtn">Pr√©paration</button>
    </div>
</div>
<button class="config-btn" id="configBtn">‚öôÔ∏è</button>

<div class="modal" id="importModal">
    <div class="modal-content">
        <span class="close" id="closeImportBtn">&times;</span>
        <h2>Importer fichier Test DDR</h2>
        <div class="import-options">
            <div class="file-drop-zone" id="fileDropZone">
                <p>Glissez-d√©posez votre fichier Test DDR ici</p>
                <p class="or-text">ou</p>
                <button class="browse-btn" id="browseBtn">Parcourir les fichiers</button>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none;">
            </div>
            <div class="file-info" id="fileInfo" style="display:none;">
                <p>Fichier s√©lectionn√©: <span id="fileName"></span></p>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="configModal">
    <div class="modal-content">
        <span class="close" id="closeBtn">&times;</span>
        <h2>Configuration</h2>
        <div class="config-options">
            <p style="text-align:center;color:#666;font-style:italic;">Configuration en cours de d√©veloppement...</p>
        </div>
    </div>
</div>

<script>
// ====================================================================
// ‚úÖ CORRECTION DATE DU JOUR (S'ex√©cute imm√©diatement)
// ====================================================================
const todayBadge = document.getElementById('todayBadge');
const now = new Date();
if (todayBadge) {
    todayBadge.textContent = now.toLocaleDateString('fr-FR');
}
// ====================================================================


// ====================================================================
// üîë CONFIGURATION SUPABASE : VOS CL√âS SONT CONSERV√âES ICI üîë
// ====================================================================
const SUPABASE_URL = 'https://ejirdcqcmmeybgitonmw.supabase.co'; // Votre URL de projet
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqaXJkY3FjbW1leWJnaXRvbm13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1OTY2MjYsImV4cCI6MjA3NzE3MjYyNn0.4E93ufwJ-RIjV9qT0I4t3GiI9NIzVzN_ktwDPswT7ic'; // Votre cl√© publique Anon

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
// ====================================================================

// currentWorkbook est utilis√© pour l'importation de fichier et la sauvegarde.
let currentWorkbook = null; 
// currentDDRData est le tableau JSON des donn√©es Supabase
let currentDDRData = null;
let originalFileName = null;

// ====================================================================
// NOUVELLES FONCTIONS DE GESTION DES DONN√âES SUPABASE EN TEMPS R√âEL
// ====================================================================

/**
 * Tente de parser une cha√Æne de date JSON (g√©n√©r√©e par XLSX) ou une date ISO en objet Date.
 */
function readJSONDate(dateStr) {
    if (!dateStr) return null;
    const s = String(dateStr).trim();

    // 1. Tente de parser le format fran√ßais dd/mm/yyyy (issu de la conversion XLSX)
    let parts = s.split(/[\/\-\.]/);
    if (parts.length === 3) {
        let d = +parts[0], mo = +parts[1], y = +parts[2];
        if (y < 100) y += 2000;
        if (mo >= 1 && mo <= 12 && d >= 1 && d <= 31) {
            const date = new Date(y, mo - 1, d);
            if (date.getFullYear() === y && date.getMonth() === mo - 1 && date.getDate() === d) return date;
        }
    }
    
    // 2. Tente de parser le format ISO/standard
    const p = new Date(s);
    if (!isNaN(p.getTime())) {
        return new Date(p.getFullYear(), p.getMonth(), p.getDate()); // Retourne la date sans l'heure
    }

    return null;
}

/**
 * √âtablit l'abonnement en temps r√©el √† la table ddr_data.
 */
function setupRealtimeSubscription() {
    supabase
        .channel('ddr_changes') // Nom du canal unique
        .on('postgres_changes', { event: '*', schema: 'public', table: 'ddr_data' }, (payload) => {
            console.log('Changement Supabase re√ßu:', payload);
            showStatusMessage('Mise √† jour des donn√©es re√ßue en temps r√©el...', 'success');
            // Re-fetch la derni√®re entr√©e pour garantir l'affichage des donn√©es les plus r√©centes
            fetchAndProcessLatestData();
        })
        .subscribe();
}

/**
 * R√©cup√®re le dernier enregistrement de ddr_data et d√©clenche l'affichage.
 */
async function fetchAndProcessLatestData() {
    // 1. R√©cup√©rer le dernier enregistrement (le plus r√©cent)
    const { data: records, error: fetchError } = await supabase
        .from('ddr_data')
        .select('id, nom_fichier, donnees, date_sauvegarde')
        .order('date_sauvegarde', { ascending: false })
        .limit(1);

    if (fetchError) {
        showStatusMessage('Erreur de r√©cup√©ration des donn√©es Supabase: ' + fetchError.message, 'error');
        // Si Supabase √©choue, on ne fait rien pour laisser la possibilit√© d'importer un fichier
        return;
    }

    if (!records || records.length === 0) {
        // Aucune donn√©e Supabase, on laisse la possibilit√© d'importer un fichier
        showStatusMessage('Aucune donn√©e DDR trouv√©e sur Supabase. Importez un fichier.', 'error');
        updateSaveButtonState(false);
        // Nettoyer les KPIs
        renderKPI_Col(0, 0, 0);
        renderKPI_Disc(0, 0, 0);
        renderLineChart(document.getElementById('advChart'), [], [], -1, -1);
        return;
    }

    const latestRecord = records[0];
    currentDDRData = latestRecord.donnees;
    originalFileName = latestRecord.nom_fichier;

    // 2. Mettre √† jour le statut de l'UI
    const updateTime = new Date(latestRecord.date_sauvegarde);
    showStatusMessage(`Donn√©es du fichier "${latestRecord.nom_fichier}" charg√©es depuis Supabase (Mis √† jour: ${updateTime.toLocaleTimeString('fr-FR')}).`, 'success');
    
    // Mettre √† jour l'info de derni√®re mise √† jour
    const saveInfo = document.getElementById('saveInfo');
    const saveDateTime = document.getElementById('saveDateTime');
    saveDateTime.textContent=`Live : ${updateTime.toLocaleDateString('fr-FR')} √† ${updateTime.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}`;
    saveInfo.style.display='block';
    
    // 3. Traiter et Rendre les KPIs/Graphiques
    processAndRenderJSONData(currentDDRData);

    // 4. D√©sactiver le bouton Sauvegarder (puisqu'on vient de charger le live)
    // et activer le bouton Pr√©paration
    updateSaveButtonState(false, true); 
}

/**
 * Calcule et affiche les KPIs/Graphiques √† partir du tableau JSON de Supabase.
 * @param {Array} data Le tableau d'objets JSON.
 */
function processAndRenderJSONData(data) {
    if (!data || data.length === 0) return;

    // Assumer que le JSON a les en-t√™tes de l'Excel (d'apr√®s convertWorkbookToJSON)
    const firstRow = data[0];
    const headers = Object.keys(firstRow);

    // Utilisation des noms de colonnes ou indices pour plus de robustesse
    const KEY_DDR_ID = headers.find(h => h.includes('DDR')) || headers[1]; 
    const KEY_NEXT_CONTROL = headers.find(h => h.includes('Prochain Contr√¥le') || h.includes('F')) || headers[5]; 
    const KEY_LAST_CONTROL = headers.find(h => h.includes('Dernier Contr√¥le') || h.includes('E')) || headers[4]; 
    const KEY_PLANNED_DATE = headers.find(h => h.includes('Date Planifi√©e') || h.includes('O')) || headers[14]; 
    const KEY_SHUTDOWN_NAME = headers.find(h => h.includes('Arr√™t') || h.includes('A')) || headers[0]; 
    
    // Simplification des arr√™ts planifi√©s (√† adapter si vous avez la feuille 'arr√™t programm√©' dans Supabase)
    const hardcodedShutdowns = {
        'arr√™t a': 2, // Mars
        'arr√™t b': 5, // Juin
        'arr√™t c': 9, // Octobre
    };

    let totalDDR = 0;
    let enRetard = 0;
    let totalDDRPlanifie = 0;
    let tested = 0;
    
    const today = new Date();
    const todayNoTime = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const thisYear = today.getFullYear();

    const monthlyCountsReal = new Array(12).fill(0);
    const monthlyCountsTheo = new Array(12).fill(0);
    let lastTheoreticalMonthIndex = -1;

    for (const row of data) {
        const hasDDR = row[KEY_DDR_ID] && String(row[KEY_DDR_ID]).trim() !== '';
        if (!hasDDR) continue;
        
        // --- KPI 1: Conformit√© (Colonne F) ---
        totalDDR++;
        const nextDate = readJSONDate(row[KEY_NEXT_CONTROL]);
        if (!nextDate || nextDate < todayNoTime) {
            enRetard++;
        }

        // --- Progression & Courbe (Colonnes E, O, A) ---
        const lastControlDate = readJSONDate(row[KEY_LAST_CONTROL]);
        const plannedDateValue = row[KEY_PLANNED_DATE];
        
        // Progression R√©elle (Colonne E)
        if (lastControlDate && lastControlDate.getFullYear() === thisYear && lastControlDate <= todayNoTime) {
            tested++;
            monthlyCountsReal[lastControlDate.getMonth()]++;
        }

        // Progression Th√©orique (Colonne O ou A)
        const hasPlan = plannedDateValue && String(plannedDateValue).trim() !== '';
        if (hasPlan) {
            totalDDRPlanifie++;
            
            let theoMonthIndex = -1;
            
            if (plannedDateValue instanceof Date || !isNaN(Date.parse(plannedDateValue)) || String(plannedDateValue).split(/[\/\-\.]/).length === 3) {
                // Valeur est une date
                const dO = readJSONDate(plannedDateValue);
                if (dO && dO.getFullYear() === thisYear) { theoMonthIndex = dO.getMonth(); }
            } else {
                // Valeur est un texte (Arr√™t Programm√©)
                const shutdownName = row[KEY_SHUTDOWN_NAME] ? String(row[KEY_SHUTDOWN_NAME]).trim().toLowerCase() : '';
                for (const stopName in hardcodedShutdowns) {
                    if (shutdownName.includes(stopName.toLowerCase())) {
                        theoMonthIndex = hardcodedShutdowns[stopName];
                        break;
                    }
                }
            }
            
            if (theoMonthIndex !== -1) {
                monthlyCountsTheo[theoMonthIndex]++;
                lastTheoreticalMonthIndex = Math.max(lastTheoreticalMonthIndex, theoMonthIndex);
            }
        }
    }

    // --- Rendu des r√©sultats
    const pctConformite = totalDDR ? (1 - (enRetard / totalDDR)) * 100 : 0;
    renderKPI_Col(pctConformite, totalDDR - enRetard, totalDDR);

    const pctProgression = totalDDRPlanifie ? (tested / totalDDRPlanifie) * 100 : 0;
    renderKPI_Disc(pctProgression, tested, totalDDRPlanifie);

    // Calcul cumul√© pour la courbe
    const cumPercReal = []; let cumR = 0;
    for (let m = 0; m < 12; m++) { cumR += monthlyCountsReal[m]; cumPercReal[m] = totalDDRPlanifie ? (cumR / totalDDRPlanifie) : 0; }

    const cumPercTheo = []; 
    if (totalDDRPlanifie > 0 && lastTheoreticalMonthIndex !== -1) {
        let cumT = 0;
        for (let m = 0; m <= lastTheoreticalMonthIndex; m++) {
            cumT += monthlyCountsTheo[m];
            cumPercTheo[m] = totalDDRPlanifie ? (cumT / totalDDRPlanifie) : 0;
        }
        const maxTheoValue = cumPercTheo[lastTheoreticalMonthIndex];
        for (let m = lastTheoreticalMonthIndex; m < 12; m++) {
            cumPercTheo[m] = maxTheoValue;
        }
    } else {
        cumPercTheo.fill(0);
    }
    const chartSvg = document.getElementById('advChart');
    const currentMonthIndex = today.getMonth();
    renderLineChart(chartSvg, cumPercReal, cumPercTheo, lastTheoreticalMonthIndex, currentMonthIndex);
}

// ====================================================================

/**
 * Fonction utilitaire de la librairie XLSX.js pour convertir une cha√Æne 
 * binaire (Base64 d√©cod√©e) en ArrayBuffer. N√©cessaire pour la transmission via localStorage.
 */
function s2ab(s) { 
    const buf = new ArrayBuffer(s.length);
    const view = new Uint8Array(buf);
    for (let i=0; i!==s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
    return buf;
}

// ====================================================================
// FONCTIONS DE CONVERSION ET DE SAUVEGARDE (EXCEL -> SUPABASE)
// ====================================================================

/**
 * Convertit la feuille 'liste ddr' du classeur en un tableau d'objets JSON.
 * @param {Object} wb Le classeur XLSX.
 * @returns {Array} Un tableau d'objets repr√©sentant les lignes de la feuille.
 */
function convertWorkbookToJSON(wb) {
    try {
        const sheetName = 'liste ddr';
        const sh = findSheet(wb, sheetName);
        // Utilise l'utilitaire XLSX pour convertir la feuille en un tableau d'objets (cl√©=nom de colonne)
        // dateNF est important pour que les dates soient lisibles par JS/Supabase si on utilise la colonne 'v'
        const jsonData = XLSX.utils.sheet_to_json(sh, { header: 1, raw: false, dateNF: "yyyy-mm-dd" });
        
        if (!jsonData || jsonData.length < 1) return [];

        const header = jsonData[0];
        const data = [];

        // It√©rer sur les lignes de donn√©es (√† partir de la deuxi√®me ligne)
        for (let i = 1; i < jsonData.length; i++) {
            const row = jsonData[i];
            const obj = {};
            for (let j = 0; j < header.length; j++) {
                const key = header[j] ? String(header[j]).trim() : `Col_${j+1}`;
                obj[key] = row[j];
            }
            data.push({ row_index_excel: i + 2, ...obj }); 
        }

        return data;

    } catch(e) {
        console.error("Erreur lors de la conversion du classeur en JSON:", e);
        return { error: 'Conversion failed', details: e.message };
    }
}

/**
 * Enregistre les donn√©es converties et les m√©tadonn√©es dans Supabase.
 * @param {Array|Object} dataToSave Le tableau d'objets ou un objet d'erreur √† sauvegarder.
 */
async function saveToSupabase(dataToSave) {
    if (!originalFileName || !dataToSave) {
        return;
    }

    const TABLE_NAME = 'ddr_data'; 
    
    // Tentative d'insertion
    const { data, error } = await supabase
        .from(TABLE_NAME)
        .insert([
            { 
                nom_fichier: originalFileName, 
                date_sauvegarde: new Date().toISOString(),
                donnees: dataToSave 
            },
        ])
        .select();

    if (error) {
        showStatusMessage(`Erreur Supabase (Table "${TABLE_NAME}"): √âchec de l‚Äôenregistrement en ligne.`, 'error');
        console.error('Erreur Supabase:', error);
    } else {
        showStatusMessage('Fichier enregistr√© avec succ√®s sur Supabase. Mise √† jour en temps r√©el envoy√©e.', 'success');
        console.log('Donn√©es Supabase ins√©r√©es:', data);
    }
}


// ====================================================================
// LOGIQUE DE D√âMARRAGE ET HANDLERS
// ====================================================================

document.addEventListener('DOMContentLoaded', function(){
    // UI refs
    const importBtn=document.getElementById('importBtn');
    const importModal=document.getElementById('importModal');
    const closeImportBtn=document.getElementById('closeImportBtn');
    const fileInput=document.getElementById('fileInput');
    const browseBtn=document.getElementById('browseBtn');
    const fileDropZone=document.getElementById('fileDropZone');
    const fileInfo=document.getElementById('fileInfo');
    const fileName=document.getElementById('fileName');
    const saveMainBtn=document.getElementById('saveMainBtn');
    const prepMainBtn=document.getElementById('prepMainBtn'); 
    const saveInfo=document.getElementById('saveInfo');
    const saveDateTime=document.getElementById('saveDateTime');
    const statusMessage=document.getElementById('statusMessage');
    
    // Config Modal Refs 
    const configModal=document.getElementById('configModal');
    const closeConfigBtn=document.getElementById('closeBtn');

    // KPI refs
    const kpiRoot=document.getElementById('kpiConformite');
    const kpiBar=document.getElementById('kpiBar');
    const kpiPct=document.getElementById('kpiPct');

    const kpiProgRoot=document.getElementById('kpiProgression');
    const disc=document.getElementById('disc');
    const discPct=document.getElementById('discPct');
    const statTotal=document.getElementById('statTotal');
    const statTested=document.getElementById('statTested');

    // Chart refs
    const chartSvg=document.getElementById('advChart');
    
    // 1. Initialiser le chargement et la souscription Supabase
    fetchAndProcessLatestData();
    setupRealtimeSubscription();

    function openImportModal(){ 
        importModal.classList.add('show'); 
        document.body.style.overflow='hidden'; 
        saveMainBtn.classList.remove('saved');
        // Si on ouvre la modale, on d√©sactive le bouton de sauvegarde jusqu'√† l'import
        updateSaveButtonState(false, prepMainBtn.classList.contains('enabled'));
    }
    function closeImportModal(){ importModal.classList.remove('show'); document.body.style.overflow='auto'; }
    function openConfigModal(){ configModal.classList.add('show'); document.body.style.overflow='hidden'; }
    function closeConfigModal(){ configModal.classList.remove('show'); document.body.style.overflow='auto'; }
    function showStatusMessage(message,type='success'){
        statusMessage.textContent=message;
        statusMessage.className=`status-message show ${type}`;
        setTimeout(()=>statusMessage.classList.remove('show'),3000);
    }
    
    // Gestionnaire d'√©tat des boutons (Adapt√©)
    function updateSaveButtonState(saveEnabled, prepEnabled = false){
        if(saveEnabled) {
            saveMainBtn.classList.add('enabled');
            // Le bouton Pr√©paration est aussi activ√© apr√®s l'import local
            prepMainBtn.classList.add('enabled'); 
        }
        else { 
            saveMainBtn.classList.remove('enabled'); 
        }
        
        // Si on a des donn√©es (Supabase ou import) le bouton pr√©paration est activ√©
        if(prepEnabled || currentDDRData || currentWorkbook) {
            prepMainBtn.classList.add('enabled');
        } else {
            prepMainBtn.classList.remove('enabled');
        }
    }

    importBtn.onclick=openImportModal;
    closeImportBtn.onclick=closeImportModal;
    closeConfigBtn.onclick=closeConfigModal;
    
    browseBtn.onclick=()=>fileInput.click();
    saveMainBtn.onclick=()=>{ 
        if(saveMainBtn.classList.contains('enabled')) saveExcelFile(); 
    };
    prepMainBtn.onclick=()=>{ 
        if(prepMainBtn.classList.contains('enabled')) openPreparationPage(); 
    }; 

    fileInput.onchange=e=>{ const f=e.target.files[0]; if(f) handleFile(f); };
    fileDropZone.ondragover=e=>e.preventDefault();
    fileDropZone.ondrop=e=>{ e.preventDefault(); const f=e.dataTransfer.files[0]; if(f) handleFile(f); };

    function handleFile(file){
        fileName.textContent=file.name; fileInfo.style.display='block'; originalFileName=file.name;
        
        if (typeof XLSX === 'undefined' || typeof XLSX.read === 'undefined') {
            showStatusMessage('Erreur: La librairie XLSX n\'a pas pu √™tre charg√©e.','error');
            return; 
        }

        const reader=new FileReader();
        reader.onload=e=>{
            try {
                // Charge le fichier dans currentWorkbook
                currentWorkbook = XLSX.read(new Uint8Array(e.target.result), {type:'array', cellDates:true});
                
                // Active la Sauvegarde et la Pr√©paration
                updateSaveButtonState(true, true); 
                importBtn.classList.add('imported');
                
                // CALCULE ET REND LES KPIS AVEC LES DONN√âES EXCEL
                const totalDDRPlanifie = computeTotalPlannedDDR(currentWorkbook);
                computeAndRenderKpiFromListeDDR(currentWorkbook);   
                computeAndRenderProgressFromColE(currentWorkbook, totalDDRPlanifie); 
                computeAndRenderProgressCurve(currentWorkbook, totalDDRPlanifie);     

                showStatusMessage(`Fichier "${file.name}" import√© et donn√©es charg√©es.`, 'success');
                // Masque l'info de derni√®re sauvegarde Supabase pour indiquer que c'est une version locale
                document.getElementById('saveInfo').style.display='none';
                setTimeout(closeImportModal,1000);

            } catch(error) {
                 showStatusMessage('Erreur de traitement du fichier Excel: '+error.message,'error');
                 currentWorkbook = null;
                 updateSaveButtonState(false, false);
                 return; 
            }
        };
        reader.readAsArrayBuffer(file);
    }

    async function saveExcelFile(){
        if(!currentWorkbook || !originalFileName){ showStatusMessage('Aucun fichier √† sauvegarder.','error'); return; }
        
        let localSaveSuccess = false;
        
        // --- 1. Sauvegarde locale (T√©l√©chargement) ---
        const ts=new Date().toISOString().slice(0,19).replace(/[:]/g,'-');
        const nameWithoutExt=originalFileName.replace(/\.[^/.]+$/,'');
        const extension=(originalFileName.split('.').pop()||'xlsx').toLowerCase();
        try{
            const out=XLSX.write(currentWorkbook,{bookType:extension==='xls'?'xls':'xlsx',type:'array',cellDates:true,cellNF:true,cellText:false});
            const blob=new Blob([out],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
            const url=URL.createObjectURL(blob);
            const a=document.createElement('a'); a.href=url; a.download=`${nameWithoutExt}_modifie_${ts}.${extension}`; a.click();
            URL.revokeObjectURL(url);
            showStatusMessage('Fichier t√©l√©charg√© localement.', 'success');
            
            const now=new Date();
            // Met √† jour l'info de sauvegarde pour l'√©tat local
            saveDateTime.textContent=`Sauv√© en local : ${now.toLocaleDateString('fr-FR')} √† ${now.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}`;
            saveInfo.style.display='block';
            saveMainBtn.classList.add('saved');
            localSaveSuccess = true;
            
        }catch(e){ 
            showStatusMessage('Erreur lors du t√©l√©chargement local : '+e.message,'error'); 
            localSaveSuccess = false;
        }

        // --- 2. Sauvegarde Supabase ---
        if (localSaveSuccess) {
            const jsonData = convertWorkbookToJSON(currentWorkbook);
            if(jsonData && !jsonData.error) {
                // Sauvegarde vers Supabase. Cela d√©clenchera le Realtime sur les autres pages.
                await saveToSupabase(jsonData);
                // Apr√®s sauvegarde r√©ussie sur Supabase, on d√©sactive le bouton Sauvegarder
                // pour indiquer que l'√©tat local est en sync
                updateSaveButtonState(false, true); 
                saveMainBtn.classList.remove('saved'); 
            } else {
                showStatusMessage('Erreur: Conversion du fichier en JSON √©chou√©e. Non sauvegard√© sur Supabase.', 'error');
            }
        }
    }

    async function openPreparationPage(){
        // On priorise le fichier Excel si un import a √©t√© fait, sinon on utilise les donn√©es Supabase (currentDDRData)
        if(currentWorkbook){ 
            try{
                // Logic pour fichier Excel (pour conserver les donn√©es XLSX originales)
                const base64Out = XLSX.write(currentWorkbook,{bookType:'xlsx',type:'base64',cellDates:true,cellNF:true,cellText:false});
                localStorage.setItem('ddr_original_workbook_data', base64Out);
                localStorage.setItem('ddr_filename', originalFileName);
                window.location.href = 'Autre page Test DDR/Pr√©paration Test DDR.html';
                showStatusMessage('Ouverture de la page de pr√©paration avec fichier Excel.','success');
            }catch(e){ 
                showStatusMessage('Erreur lors de la pr√©paration des donn√©es Excel : '+e.message,'error');
                localStorage.removeItem('ddr_original_workbook_data'); 
                localStorage.removeItem('ddr_filename');
            }
        }
        else if(currentDDRData){
            try{
                // Logic pour donn√©es Supabase JSON
                localStorage.setItem('ddr_original_data_json', JSON.stringify(currentDDRData));
                localStorage.setItem('ddr_filename', originalFileName);
                window.location.href = 'Autre page Test DDR/Pr√©paration Test DDR.html';
                showStatusMessage('Ouverture de la page de pr√©paration avec donn√©es Supabase.','success');
            }catch(e){ 
                showStatusMessage('Erreur lors de la pr√©paration des donn√©es Supabase : '+e.message,'error');
            }
        }
        else {
            showStatusMessage('Aucune donn√©e charg√©e (ni fichier, ni Supabase) pour la pr√©paration.','error'); 
        }
    }

    window.addEventListener('storage', (event) => {
        if (event.key === 'ddr_modified_workbook_data' && event.newValue) {
            try {
                // Donn√©es venant d'un Excel modifi√© depuis la page de pr√©paration
                const base64Data = event.newValue;
                const s = window.atob(base64Data);
                const buffer = s2ab(s);
                currentWorkbook = XLSX.read(buffer, {type:'array', cellDates:true});
                
                // Met √† jour les KPIs avec l'Excel MODIFI√â
                const totalDDRPlanifie = computeTotalPlannedDDR(currentWorkbook);
                computeAndRenderKpiFromListeDDR(currentWorkbook);
                computeAndRenderProgressFromColE(currentWorkbook, totalDDRPlanifie); 
                computeAndRenderProgressCurve(currentWorkbook, totalDDRPlanifie);
                
                showStatusMessage('Donn√©es mises √† jour depuis la page de pr√©paration. Pr√™tes √† √™tre sauvegard√©es.','success');
                updateSaveButtonState(true, true); // Active le bouton Sauvegarder
                saveMainBtn.classList.remove('saved'); 
                
                localStorage.removeItem('ddr_modified_workbook_data');

            } catch(error) {
                showStatusMessage('Erreur lors de la lecture des donn√©es modifi√©es : ' + error.message,'error');
            }
        }
    });

    /* ===== Fonctions de Traitement de Donn√©es (Excel - inchang√©es) ===== */
    
    function findSheet(wb, expectedNameLower){
        let name=null;
        for(const n of wb.SheetNames){ 
            if(n.trim().toLowerCase()===expectedNameLower.trim().toLowerCase()){ 
                name=n; 
                break; 
            } 
        }
        if (!name && wb.SheetNames.length > 0) { name = wb.SheetNames[0]; }
        const sh=wb.Sheets[name];
        if(!sh) throw new Error(`Feuille "${expectedNameLower}" introuvable ou fichier vide.`);
        return sh;
    }
    function readExcelDate(cell){
        if(!cell) return null;
        if(cell.t==='d' && cell.v instanceof Date){
            return new Date(cell.v.getFullYear(), cell.v.getMonth(), cell.v.getDate());
        }
        if(cell.t==='n'){
            const o=XLSX.SSF.parse_date_code(cell.v);
            if(o) return new Date(o.y, o.m-1, o.d);
        }
        if(cell.t==='s' && typeof cell.v==='string'){
            const s=cell.v.trim();
            let m=s.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
            if(m){ const y=+m[1], mo=+m[2], d=+m[3]; if(mo>=1&&mo<=12&&d>=1&&d<=31) return new Date(y,mo-1,d); }
            m=s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
            if(m){ let d=+m[1], mo=+m[2], y=+m[3]; if(y<100) y+=2000; if(mo>=1&&mo<=12&&d>=1&&d<=31) return new Date(y,mo-1,d); }
            const p=new Date(s); if(!isNaN(p)) return new Date(p.getFullYear(),p.getMonth(),p.getDate());
        }
        return null;
    }
    function computeTotalPlannedDDR(wb) {
        try {
            const shDDR = findSheet(wb, 'liste ddr');
            const rngDDR = XLSX.utils.decode_range(shDDR['!ref']);
            let totalDDRPlanifie = 0;
            for (let r = rngDDR.s.r + 1; r <= rngDDR.e.r; r++) {
                const cellB = shDDR[XLSX.utils.encode_cell({ c: 1, r })];
                const cellO = shDDR[XLSX.utils.encode_cell({ c: 14, r })]; // O: Date planifi√©e
                const hasDDR = cellB && String(cellB.v ?? '').trim() !== '';
                const hasPlan = cellO && String(cellO.v ?? '').trim() !== '';
                if (hasDDR && hasPlan) { totalDDRPlanifie++; }
            }
            return totalDDRPlanifie;
        } catch (e) { showStatusMessage('Erreur de calcul du total planifi√© : ' + e.message, 'error'); return 0; }
    }
    function computeAndRenderKpiFromListeDDR(wb){
        try{
            const sh=findSheet(wb,'liste ddr');
            const rng=XLSX.utils.decode_range(sh['!ref']);
            let total=0,enRetard=0;
            const today=new Date();
            const todayNoTime=new Date(today.getFullYear(),today.getMonth(),today.getDate());
            for(let r=rng.s.r+1;r<=rng.e.r;r++){
                const cellB=sh[XLSX.utils.encode_cell({c:1,r})];
                const hasDDR=cellB && String(cellB.v??'').trim()!=='';
                if(!hasDDR) continue; total++;
                const nextDate=readExcelDate(sh[XLSX.utils.encode_cell({c:5,r})]); // F
                if(!nextDate || nextDate < todayNoTime) enRetard++;
            }
            const pct= total ? (1-(enRetard/total))*100 : 0;
            renderKPI_Col(pct, total-enRetard, total);
        }catch(e){ showStatusMessage('KPI conformit√© indisponible: '+e.message,'error'); }
    }
    function computeAndRenderProgressFromColE(wb, totalDDRPlanifie){
        try{
            const sh=findSheet(wb,'liste ddr');
            const rng=XLSX.utils.decode_range(sh['!ref']);
            let tested=0;
            const thisYear=(new Date()).getFullYear();
            const todayNoTime = new Date(thisYear, (new Date()).getMonth(), (new Date()).getDate()); 
            for(let r=rng.s.r+1;r<=rng.e.r;r++){
                const cellB=sh[XLSX.utils.encode_cell({c:1,r})];
                const hasDDR=cellB && String(cellB.v??'').trim()!=='';
                if(!hasDDR) continue;
                const d=readExcelDate(sh[XLSX.utils.encode_cell({c:4,r})]); // E: Date dernier Contr√¥le
                if(d && d.getFullYear()===thisYear && d <= todayNoTime) tested++;
            }
            const pct= totalDDRPlanifie ? (tested/totalDDRPlanifie)*100 : 0;
            renderKPI_Disc(pct,tested,totalDDRPlanifie);
        }catch(e){ showStatusMessage('KPI progression indisponible: '+e.message,'error'); }
    }
    function computeAndRenderProgressCurve(wb, totalDDRPlanifie){
        const thisYear=(new Date()).getFullYear();
        let shDDR, rngDDR, shArret, rngArret;
        try { shDDR = findSheet(wb,'liste ddr'); rngDDR = XLSX.utils.decode_range(shDDR['!ref']); } 
        catch (e) { showStatusMessage('Feuille "liste ddr" manquante pour la courbe: '+e.message,'error'); return; }
        
        try { shArret = findSheet(wb,'arr√™t programm√©'); rngArret = XLSX.utils.decode_range(shArret['!ref']); }
        catch (e) { shArret = null; }

        const todayNoTime = new Date(thisYear, (new Date()).getMonth(), (new Date()).getDate()); 

        const shutdownMap = {};
        const monthNames = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin', 'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];
        
        if (shArret) {
            for(let r=rngArret.s.r+1;r<=rngArret.e.r;r++){
                const cellArret = shArret[XLSX.utils.encode_cell({c:0,r})]; 
                const cellMois = shArret[XLSX.utils.encode_cell({c:1,r})]; 
                if(cellArret && cellMois && String(cellArret.v??'').trim()!==''){
                    const stopName = String(cellArret.v).trim().toLowerCase();
                    const monthName = String(cellMois.v).trim().toLowerCase();
                    const monthIndex = monthNames.indexOf(monthName);
                    if(monthIndex !== -1){ shutdownMap[stopName] = monthIndex; }
                }
            }
        }
        
        const monthlyCountsReal=new Array(12).fill(0);
        const monthlyCountsTheo=new Array(12).fill(0);
        let lastTheoreticalMonthIndex = -1;

        for(let r=rngDDR.s.r+1;r<=rngDDR.e.r;r++){
            const cellB=shDDR[XLSX.utils.encode_cell({c:1,r})];
            const hasDDR=cellB && String(cellB.v??'').trim()!=='';
            if(!hasDDR) continue; 
            
            const cellE=shDDR[XLSX.utils.encode_cell({c:4,r})];
            const dE=readExcelDate(cellE);
            
            if(dE && dE.getFullYear()===thisYear && dE <= todayNoTime){ monthlyCountsReal[dE.getMonth()]++; }

            const cellO=shDDR[XLSX.utils.encode_cell({c:14,r})];
            if(cellO && String(cellO.v??'').trim()!==''){
                let theoMonthIndex = -1;
                if(cellO.t === 'd' || cellO.t === 'n'){ 
                    const dO=readExcelDate(cellO);
                    if(dO && dO.getFullYear()===thisYear) theoMonthIndex = dO.getMonth();
                } else if(cellO.t === 's'){ 
                    const vO=String(cellO.v).trim().toLowerCase();
                    for (const stopName in shutdownMap) {
                        if (vO.includes(stopName)) { theoMonthIndex = shutdownMap[stopName]; break; }
                    }
                }
                if(theoMonthIndex !== -1){
                    monthlyCountsTheo[theoMonthIndex]++;
                    lastTheoreticalMonthIndex = Math.max(lastTheoreticalMonthIndex, theoMonthIndex);
                }
            }
        }
        
        const totalBase = totalDDRPlanifie;
        
        const cumPercReal=[]; let cumR=0;
        for(let m=0;m<12;m++){ cumR += monthlyCountsReal[m]; cumPercReal[m] = totalBase ? (cumR/totalBase) : 0; }

        const cumPercTheo=[]; 
        if(totalBase > 0 && lastTheoreticalMonthIndex !== -1) {
            let cumT=0;
            for(let m=0;m<=lastTheoreticalMonthIndex;m++){
                cumT += monthlyCountsTheo[m];
                cumPercTheo[m] = totalBase ? (cumT/totalBase) : 0;
            }
            const maxTheoValue = cumPercTheo[lastTheoreticalMonthIndex];
            for(let m = lastTheoreticalMonthIndex; m < 12; m++) {
                cumPercTheo[m] = maxTheoValue;
            }
        } else {
             cumPercTheo.fill(0);
        }

        renderLineChart(chartSvg, cumPercReal, cumPercTheo, lastTheoreticalMonthIndex, todayNoTime.getMonth());
    }

    /* ===== Fonctions de Rendu (Inchag√©es) ===== */
    
    function renderKPI_Col(pct, conformes, total){
        const p=Math.max(0,Math.min(100,pct));
        kpiPct.textContent=p.toFixed(1).replace('.',',')+' %';
        const h=Math.round(200*(p/100));
        kpiBar.style.height=h+'px';
        if(p<50) kpiBar.style.background='#e74c3c';
        else if(p<80) kpiBar.style.background='#f39c12';
        else kpiBar.style.background='#27ae60';
        kpiBar.title=`${conformes}/${total} √† jour (F ‚â• aujourd‚Äôhui)`;
        kpiRoot.style.display='block';
    }
    function renderKPI_Disc(pct,tested,total){
        const p=Math.max(0,Math.min(100,pct));
        disc.style.background=`conic-gradient(#27ae60 ${p*3.6}deg, #e6eef5 0deg)`;
        discPct.textContent=p.toFixed(1).replace('.',',')+' %';
        statTotal.textContent=total; statTested.textContent=tested;
        kpiProgRoot.style.display='block';
    }
    function renderLineChart(svg, cumR, cumT, lastTheoreticalMonthIndex, currentMonthIndex){
        while(svg.firstChild) svg.removeChild(svg.firstChild);
        const W=980,H=340, ml=60, mr=20, mt=20, mb=40;
        const innerW=W-ml-mr, innerH=H-mt-mb;
        const months=['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ªt','Sept','Oct','Nov','D√©c'];
        const X = m => (innerW)*(m/11);
        const Y = v => innerH*(1-v);

        const g=document.createElementNS('http://www.w3.org/2000/svg','g');
        g.setAttribute('transform',`translate(${ml},${mt})`);
        svg.appendChild(g);

        for(let i=0;i<=4;i++){
            const y=innerH - (innerH*(i/4));
            const line=document.createElementNS(svg.namespaceURI,'line');
            line.setAttribute('x1',0); line.setAttribute('x2',innerW);
            line.setAttribute('y1',y); line.setAttribute('y2',y);
            line.setAttribute('stroke','#e5ecf3'); line.setAttribute('stroke-width','1');
            g.appendChild(line);

            const lbl=document.createElementNS(svg.namespaceURI,'text');
            lbl.setAttribute('x',-10); lbl.setAttribute('y',y+4);
            lbl.setAttribute('text-anchor','end'); lbl.setAttribute('font-size','11'); lbl.setAttribute('fill','#607d8b');
            lbl.textContent=(i*25)+'%';
            g.appendChild(lbl);
        }
        for(let m=0;m<12;m++){
            const x=(innerW)*(m/11);
            const t=document.createElementNS(svg.namespaceURI,'text');
            t.setAttribute('x',x); t.setAttribute('y',innerH+18);
            t.setAttribute('text-anchor','middle'); t.setAttribute('font-size','11'); t.setAttribute('fill','#607d8b');
            t.textContent=months[m];
            g.appendChild(t);
        }

        function pathFrom(arr, limitIndex){
            let d=''; 
            const actualLimit = Math.min(11, limitIndex); 
            for(let m=0;m<=actualLimit;m++){
                const x=X(m), y=Y(arr[m]); 
                d += (m===0? `M ${x} ${y}`:` L ${x} ${y}`); 
            }
            return d;
        }

        const pTheo=document.createElementNS(svg.namespaceURI,'path');
        pTheo.setAttribute('d',pathFrom(cumT, 11)); 
        pTheo.setAttribute('fill','none'); pTheo.setAttribute('stroke','#3498db');
        pTheo.setAttribute('stroke-width','4'); pTheo.setAttribute('stroke-dasharray','8 4');
        g.appendChild(pTheo);

        const pReal=document.createElementNS(svg.namespaceURI,'path');
        pReal.setAttribute('d',pathFrom(cumR, currentMonthIndex)); 
        pReal.setAttribute('fill','none'); pReal.setAttribute('stroke','#2ecc71'); pReal.setAttribute('stroke-width','4');
        g.appendChild(pReal);

        let lastTheoLabelIndex = -1;
        for(let m=11; m>=0; m--) {
            if (cumT[m] > 0) { lastTheoLabelIndex = m; break; }
        }
        for(let m=0;m<12;m++){
            const cx=X(m), cy=Y(cumT[m]);
            if (cumT[m] > 0) {
                const dot=document.createElementNS(svg.namespaceURI,'circle');
                dot.setAttribute('cx',cx); dot.setAttribute('cy',cy); dot.setAttribute('r',3.5);
                dot.setAttribute('fill','#3498db'); dot.setAttribute('opacity','0.9');
                g.appendChild(dot);
            }
            if (m === lastTheoLabelIndex && cumT[m] > 0) {
                const label=document.createElementNS(svg.namespaceURI,'text');
                label.setAttribute('x',cx); label.setAttribute('y',cy-10);
                label.setAttribute('text-anchor','middle'); label.setAttribute('font-size','12');
                label.setAttribute('font-weight','800'); label.setAttribute('fill','#3498db');
                label.setAttribute('stroke','#fff'); label.setAttribute('stroke-width','3');
                label.setAttribute('paint-order','stroke');
                const pct = (cumT[m]*100).toFixed(1).replace('.',',') + ' %';
                label.textContent = pct;
                g.appendChild(label);
            }
        }
        for(let m=0;m<=currentMonthIndex;m++){
            const cx=X(m), cy=Y(cumR[m]);
            if (cumR[m] > 0) {
                const dot=document.createElementNS(svg.namespaceURI,'circle');
                dot.setAttribute('cx',cx); dot.setAttribute('cy',cy); dot.setAttribute('r',3.5);
                dot.setAttribute('fill','#2ecc71'); dot.setAttribute('opacity','0.9');
                g.appendChild(dot);
            }
            if(m===currentMonthIndex && cumR[m]>0){
                const label=document.createElementNS(svg.namespaceURI,'text');
                label.setAttribute('x',cx); label.setAttribute('y',cy-10);
                label.setAttribute('text-anchor','middle'); label.setAttribute('font-size','12');
                label.setAttribute('font-weight','800'); label.setAttribute('fill','#2c3e50');
                label.setAttribute('stroke','#fff'); label.setAttribute('stroke-width','3');
                label.setAttribute('paint-order','stroke');
                const pct = (cumR[m]*100).toFixed(1).replace('.',',') + ' %';
                label.textContent = pct;
                g.appendChild(label);
            }
        }

        const today=new Date();
        const daysInMonth=new Date(today.getFullYear(), today.getMonth()+1, 0).getDate();
        const frac = today.getMonth() + (today.getDate()-1)/daysInMonth;
        const xToday = X(frac);
        const vLine=document.createElementNS(svg.namespaceURI,'line');
        vLine.setAttribute('x1',xToday); vLine.setAttribute('x2',xToday);
        vLine.setAttribute('y1',0); vLine.setAttribute('y2',innerH);
        vLine.setAttribute('stroke','#3498db'); vLine.setAttribute('stroke-dasharray','6 6');
        vLine.setAttribute('stroke-width','2');
        g.appendChild(vLine);

        const tag=document.createElementNS(svg.namespaceURI,'text');
        tag.setAttribute('x',xToday+6); tag.setAttribute('y',12);
        tag.setAttribute('font-size','12'); tag.setAttribute('fill','#3498db'); tag.setAttribute('font-weight','700');
        tag.textContent="Aujourd'hui";
        g.appendChild(tag);
    }
});
</script>
</body>

</html>