<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Test DDR (Live Supabase)</title>
<style>
    /* ... (Styles CSS non modifi√©s) ... */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial,sans-serif;background:linear-gradient(135deg,#87CEEB 0%,#E0F6FF 50%,#B0E0E6 100%);min-height:100vh;color:#333}
    .main-content{padding:50px 20px;text-align:center;max-width:1100px;margin:0 auto}
    .main-content h1{font-size:2.5rem;margin-bottom:30px;color:#2c3e50;text-shadow:0 2px 4px rgba(0,0,0,.1)}

    /* Date en haut √† gauche */
    .today-badge{position:fixed;top:16px;left:16px;z-index:120;background:rgba(255,255,255,.97);padding:10px 16px;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.12);font-weight:900;font-size:2rem;color:#2c3e50}

    /* Boutons */
    /* Le bouton Import est maintenant un bouton de rafra√Æchissement */
    .import-btn{position:fixed;bottom:30px;left:30px;background:linear-gradient(135deg,#2c3e50,#34495e);color:#fff;border:none;padding:12px 16px;border-radius:12px;font-size:.9rem;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;box-shadow:0 4px 15px rgba(44,62,80,.4);transition:.3s;z-index:99;width:200px;max-width:200px;min-height:56px;text-align:center}
    .import-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(44,62,80,.5)}
    .import-btn.imported{background:linear-gradient(135deg,#27ae60,#229954)} /* Utilis√© apr√®s un succ√®s */
    
    /* NOUVEAUX STYLES POUR LES DEUX BOUTONS D'ACTION */
    .action-buttons-container{position:fixed;bottom:30px;left:250px;display:flex;gap:20px;z-index:99}
    
    .save-btn-container{display:flex;flex-direction:column;align-items:center;z-index:99}
    .save-info{background:rgba(255,255,255,.95);color:#2c3e50;padding:4px 8px;border-radius:6px;font-size:.75rem;font-weight:bold;margin-bottom:5px;box-shadow:0 2px 8px rgba(0,0,0,.1);backdrop-filter:blur(10px);border:1px solid rgba(135,206,235,.3);white-space:nowrap}
    .save-btn-bottom{
        /* Bouton Sauvegarder est supprim√© car le mode est LIVE */
        display:none;
    }

    /* Bouton Pr√©paration */
    .prep-btn-container{display:flex;flex-direction:column;align-items:center;z-index:99}
    .prep-btn-bottom{
        background:linear-gradient(135deg,#9b59b6,#8e44ad); /* Violet */
        color:#fff;border:none;padding:12px 16px;border-radius:12px;
        font-size:.9rem;font-weight:bold;cursor:pointer;
        display:flex;align-items:center;justify-content:center;gap:6px;
        box-shadow:0 4px 15px rgba(155,89,182,.4);transition:.3s;
        width:200px;max-width:200px;min-height:56px;text-align:center;
        opacity:.5;pointer-events:none; /* Inactif par d√©faut */
    }
    .prep-btn-bottom.enabled{opacity:1;pointer-events:auto;cursor:pointer}
    .prep-btn-bottom.enabled:hover{
        transform:translateY(-2px);
        box-shadow:0 6px 20px rgba(155,89,182,.5);
        background:linear-gradient(135deg,#8e44ad,#6c3483);
    }
    
    /* MODIFICATION ICI pour rendre le bouton transparent/inactif */
    .config-btn{
        position:fixed;bottom:30px;right:30px;width:60px;height:60px;
        background:none; border:none;border-radius:50%;cursor:default;
        box-shadow:none; transition:.3s;display:flex;align-items:center;justify-content:center;z-index:100;
        opacity:0.3; pointer-events:none;
    }
    
    .status-message{margin-top:20px;padding:15px;border-radius:8px;font-weight:bold;opacity:0;transition:opacity .3s}
    .status-message.show{opacity:1}
    .status-message.success{background:rgba(46,204,113,.1);color:#27ae60;border-left:4px solid #2ecc71}
    .status-message.error{background:rgba(231,76,60,.1);color:#e74c3c;border-left:4px solid #e74c3c}

    /* Modal import (supprim√© car plus d'import fichier local) */
    .modal#importModal { display: none !important; }

    /* KPIs c√¥te √† c√¥te */
    .kpi-row{display:flex;gap:32px;justify-content:center;align-items:flex-end;flex-wrap:nowrap;margin-top:12px}
    .kpi2{display:none}.kpi2 .pct{font-size:1.25rem;font-weight:800}
    .kpi2 .colWrap{margin:10px auto 0;width:80px;height:220px;border-radius:8px;background:#eef2f7;box-shadow:inset 0 0 0 1px rgba(0,0,0,.08);display:flex;align-items:flex-end;justify-content:center;padding:8px;position:relative}
    .kpi2 .bar{width:40px;height:0;border-radius:6px 6px 4px 4px;background:#ccc;transition:height .6s ease,background .3s ease}
    .kpi2 .title{margin-top:6px;color:#555; font-weight: 900;} 
    
    .kpi2 .colWrap::before{content:"";position:absolute;left:6px;right:6px;height:1px;background:rgba(0,0,0,.12);bottom:calc(220px * 0.50)}
    .kpi2 .colWrap::after{content:"";position:absolute;left:6px;right:6px;height:1px;background:rgba(0,0,0,.12);bottom:calc(220px * 0.20)}
    .kpiDisc{display:none}
    
    .kpiDisc .title{margin-top:10px;color:#555; font-weight: 900;}
    
    .kpiDisc .wrap{display:flex;align-items:center;gap:18px}
    .progress-disc{width:140px;height:140px;border-radius:50%;background:conic-gradient(#27ae60 0deg,#e6eef5 0deg);display:grid;place-items:center;margin:0 auto}
    .progress-disc .inner{width:100px;height:100px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:1.4rem}
    .progress-stats{text-align:left;background:rgba(255,255,255,.97);border-radius:14px;padding:14px 16px;box-shadow:0 6px 20px rgba(0,0,0,.12);min-width:230px}
    .progress-stats .row{margin:8px 0;line-height:1.1}
    .progress-stats .label{color:#263238;font-weight:800;font-size:1.2rem}
    .progress-stats .val{font-weight:900;font-size:1.9rem}

    /* Courbe progression r√©elle */
    .chart-block{margin:28px auto 6px;background:rgba(255,255,255,.95);border-radius:14px;box-shadow:0 12px 30px rgba(0,0,0,.12);padding:12px 14px;max-width:1100px}
    .chart-title{font-weight:800;color:#2c3e50;margin-bottom:8px}
    .chart-legend{display:flex;gap:18px;justify-content:center;margin:6px 0 8px}
    .key{display:inline-flex;align-items:center;gap:6px;font-weight:700;color:#34495e}
    .dot{width:14px;height:4px;border-radius:2px;display:inline-block}
    .dot.real{background:#2ecc71}
    /* Ajout de la couleur pour la courbe th√©orique */
    .dot.planned{background:#3498db}
    svg#advChart{width:100%;height:340px;display:block}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 
</head>
<body>
<div class="today-badge" id="todayBadge">--/--/----</div>

<div class="main-content">
    <h1>Test DDR (Live)</h1>

    <div class="kpi-row">
        <div id="kpiConformite" class="kpi2">
            <div class="pct" id="kpiPct">0%</div>
            <div class="colWrap"><div class="bar" id="kpiBar"></div></div>
            <div class="title">CONFORMITE</div>
        </div>

        <div id="kpiProgression" class="kpiDisc">
            <div class="wrap">
                <div class="progress-disc" id="disc"><div class="inner" id="discPct">0%</div></div>
                <div class="progress-stats">
                    <div class="row"><span class="label">DDR total planifi√© :</span> <span class="val" id="statTotal">0</span></div>
                    <div class="row"><span class="label">Test√©s :</span> <span class="val" id="statTested">0</span></div>
                </div>
            </div>
            <div class="title">PROGRESSION</div>
        </div>
    </div>

    <div class="chart-block">
        <div class="chart-legend">
            <span class="key"><span class="dot real"></span>Progression r√©elle</span>
            <span class="key"><span class="dot planned"></span>Progression th√©orique</span>
        </div>
        <svg id="advChart" viewBox="0 0 980 340" preserveAspectRatio="xMidYMid meet"></svg>
    </div>

    <div class="status-message" id="statusMessage"></div>
</div>

<button class="import-btn" id="importBtn">Rafra√Æchir les donn√©es</button>

<div class="action-buttons-container" id="actionButtonsContainer">
    
    <div class="save-btn-container" id="saveBtnContainer">
        <div class="save-info" id="saveInfo" style="display:none;"><span id="saveDateTime"></span></div>
        <button class="save-btn-bottom" id="saveMainBtn" style="display:none;">Sauvegarder</button>
    </div>

    <div class="prep-btn-container" id="prepBtnContainer">
        <button class="prep-btn-bottom" id="prepMainBtn">Pr√©paration (Modifier)</button>
    </div>
</div>
<button class="config-btn" id="configBtn">‚öôÔ∏è</button>

<div class="modal" id="importModal"></div>

<div class="modal" id="configModal">
    <div class="modal-content">
        <span class="close" id="closeBtn">&times;</span>
        <h2>Configuration</h2>
        <div class="config-options">
            <p style="text-align:center;color:#666;font-style:italic;">Configuration en cours de d√©veloppement...</p>
        </div>
    </div>
</div>

<script>
// ====================================================================
// ‚úÖ CORRECTION DATE DU JOUR (S'ex√©cute imm√©diatement)
// ====================================================================
const todayBadge = document.getElementById('todayBadge');
const now = new Date();
if (todayBadge) {
    todayBadge.textContent = now.toLocaleDateString('fr-FR');
}
// ====================================================================


// ====================================================================
// üîë CONFIGURATION SUPABASE : VOS CL√âS SONT CONSERV√âES ICI üîë
// ====================================================================
const SUPABASE_URL = 'https://ejirdcqcmmeybgitonmw.supabase.co'; // Votre URL de projet
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqaXJkY3FjbW1leWJnaXRvbm13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1OTY2MjYsImV4cCI6MjA3NzE3MjYyNn0.4E93ufwJ-RIjV9qT0I4t3GiI9NIzVzN_ktwDPswT7ic'; // Votre cl√© publique Anon

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
// ====================================================================

// Le jeu de donn√©es actuel, sous forme de tableau JSON (non plus un objet Excel)
let currentDDRData = [];
let originalFileName = null; 

// Fonctions utilitaires (simplifi√©es)
function showStatusMessage(message, type = 'success') {
    const statusMessage = document.getElementById('statusMessage');
    statusMessage.textContent = message;
    statusMessage.className = `status-message show ${type}`;
    setTimeout(() => statusMessage.classList.remove('show'), 3000);
}

function updateSaveButtonState(hasData) {
    const prepMainBtn = document.getElementById('prepMainBtn');
    if (hasData) {
        prepMainBtn.classList.add('enabled');
    } else {
        prepMainBtn.classList.remove('enabled');
        document.getElementById('saveInfo').style.display = 'none';
    }
}

/**
 * Tente de parser une cha√Æne de date JSON (g√©n√©r√©e par XLSX) ou une date ISO en objet Date.
 */
function readJSONDate(dateStr) {
    if (!dateStr) return null;
    const s = String(dateStr).trim();

    // 1. Tente de parser le format fran√ßais dd/mm/yyyy (issu de la conversion XLSX)
    let parts = s.split(/[\/\-\.]/);
    if (parts.length === 3) {
        let d = +parts[0], mo = +parts[1], y = +parts[2];
        if (y < 100) y += 2000;
        if (mo >= 1 && mo <= 12 && d >= 1 && d <= 31) {
            const date = new Date(y, mo - 1, d);
            // V√©rifie la validit√©
            if (date.getFullYear() === y && date.getMonth() === mo - 1 && date.getDate() === d) return date;
        }
    }
    
    // 2. Tente de parser le format ISO/standard (souvent stock√© dans JSONB)
    const p = new Date(s);
    if (!isNaN(p.getTime())) {
        return new Date(p.getFullYear(), p.getMonth(), p.getDate()); // Retourne la date sans l'heure
    }

    return null;
}

// ====================================================================
// FONCTIONS DE GESTION DES DONN√âES SUPABASE EN TEMPS R√âEL
// ====================================================================

/**
 * √âtablit l'abonnement en temps r√©el √† la table ddr_data.
 */
function setupRealtimeSubscription() {
    supabase
        .channel('ddr_changes') // Nom du canal unique
        .on('postgres_changes', { event: '*', schema: 'public', table: 'ddr_data' }, (payload) => {
            console.log('Changement Supabase re√ßu:', payload);
            showStatusMessage('Mise √† jour des donn√©es re√ßue en temps r√©el...', 'success');
            // Re-fetch la derni√®re entr√©e pour garantir l'affichage des donn√©es les plus r√©centes
            fetchAndProcessLatestData();
        })
        .subscribe();
}

/**
 * R√©cup√®re le dernier enregistrement de ddr_data et d√©clenche l'affichage.
 */
async function fetchAndProcessLatestData() {
    // 1. R√©cup√©rer le dernier enregistrement (le plus r√©cent)
    const { data: records, error: fetchError } = await supabase
        .from('ddr_data')
        .select('id, nom_fichier, donnees, date_sauvegarde')
        .order('date_sauvegarde', { ascending: false })
        .limit(1);

    if (fetchError) {
        showStatusMessage('Erreur de r√©cup√©ration des donn√©es Supabase: ' + fetchError.message, 'error');
        return;
    }

    if (!records || records.length === 0) {
        showStatusMessage('Aucune donn√©e DDR trouv√©e sur Supabase.', 'error');
        updateSaveButtonState(false);
        // Nettoyer les KPIs
        renderKPI_Col(0, 0, 0);
        renderKPI_Disc(0, 0, 0);
        renderLineChart(document.getElementById('advChart'), [], [], -1, -1);
        return;
    }

    const latestRecord = records[0];
    currentDDRData = latestRecord.donnees;
    originalFileName = latestRecord.nom_fichier;

    // 2. Mettre √† jour le statut de l'UI
    const updateTime = new Date(latestRecord.date_sauvegarde);
    showStatusMessage(`Donn√©es du fichier "${latestRecord.nom_fichier}" charg√©es (Mis √† jour: ${updateTime.toLocaleTimeString('fr-FR')}).`, 'success');
    
    // Mettre √† jour l'info de derni√®re mise √† jour
    const saveInfo = document.getElementById('saveInfo');
    const saveDateTime = document.getElementById('saveDateTime');
    saveDateTime.textContent=`Mis √† jour le ${updateTime.toLocaleDateString('fr-FR')} √† ${updateTime.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}`;
    saveInfo.style.display='block';
    
    // 3. Traiter et Rendre les KPIs/Graphiques
    processAndRenderJSONData(currentDDRData);

    // 4. Activer le bouton Pr√©paration
    updateSaveButtonState(true); 
}

// ====================================================================
// FONCTION DE CALCUL DES KPIS √Ä PARTIR DU TABLEAU JSON (NOUVEAU)
// ====================================================================

function processAndRenderJSONData(data) {
    if (!data || data.length === 0) return;

    // Heuristiques pour trouver les cl√©s de colonne bas√©es sur les en-t√™tes Excel probables.
    // ASSUMPTION IMPORTANTE : Le JSON contient les en-t√™tes de l'Excel.
    const firstRow = data[0];
    const headers = Object.keys(firstRow);

    // Si vous connaissez les en-t√™tes exacts, remplacez les valeurs de droite par les noms de colonnes exacts.
    const KEY_DDR_ID = headers.find(h => h.includes('DDR')) || headers[1]; 
    const KEY_NEXT_CONTROL = headers.find(h => h.includes('Prochain Contr√¥le') || h.includes('F')) || headers[5]; 
    const KEY_LAST_CONTROL = headers.find(h => h.includes('Dernier Contr√¥le') || h.includes('E')) || headers[4]; 
    const KEY_PLANNED_DATE = headers.find(h => h.includes('Date Planifi√©e') || h.includes('O')) || headers[14]; 
    const KEY_SHUTDOWN_NAME = headers.find(h => h.includes('Arr√™t') || h.includes('A')) || headers[0]; 
    
    // Simplification : les dates planifi√©es textuelles dans l'Excel 'arr√™t programm√©' 
    // sont mapp√©es √† un mois (index 0-11).
    const hardcodedShutdowns = {
        'arr√™t A': 2, // Mars
        'arr√™t B': 5, // Juin
        'arr√™t C': 9, // Octobre
    };

    // --- Variables de calcul
    let totalDDR = 0;
    let enRetard = 0;
    let totalDDRPlanifie = 0;
    let tested = 0;
    
    const today = new Date();
    const todayNoTime = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const thisYear = today.getFullYear();

    const monthlyCountsReal = new Array(12).fill(0);
    const monthlyCountsTheo = new Array(12).fill(0);
    let lastTheoreticalMonthIndex = -1;

    for (const row of data) {
        const hasDDR = row[KEY_DDR_ID] && String(row[KEY_DDR_ID]).trim() !== '';
        if (!hasDDR) continue;
        
        // --- KPI 1: Conformit√© (Colonne F) ---
        totalDDR++;
        const nextDate = readJSONDate(row[KEY_NEXT_CONTROL]);
        if (!nextDate || nextDate < todayNoTime) {
            enRetard++;
        }

        // --- Progression & Courbe (Colonnes E, O, A) ---
        const lastControlDate = readJSONDate(row[KEY_LAST_CONTROL]);
        const plannedDateValue = row[KEY_PLANNED_DATE];
        
        // Progression R√©elle (Colonne E)
        if (lastControlDate && lastControlDate.getFullYear() === thisYear && lastControlDate <= todayNoTime) {
            tested++;
            monthlyCountsReal[lastControlDate.getMonth()]++;
        }

        // Progression Th√©orique (Colonne O ou A)
        const hasPlan = plannedDateValue && String(plannedDateValue).trim() !== '';
        if (hasPlan) {
            totalDDRPlanifie++;
            
            let theoMonthIndex = -1;
            
            if (plannedDateValue instanceof Date || !isNaN(Date.parse(plannedDateValue)) || String(plannedDateValue).split(/[\/\-\.]/).length === 3) {
                // Valeur est une date
                const dO = readJSONDate(plannedDateValue);
                if (dO && dO.getFullYear() === thisYear) { theoMonthIndex = dO.getMonth(); }
            } else {
                // Valeur est un texte (Arr√™t Programm√©)
                const shutdownName = row[KEY_SHUTDOWN_NAME] ? String(row[KEY_SHUTDOWN_NAME]).trim().toLowerCase() : '';
                for (const stopName in hardcodedShutdowns) {
                    if (shutdownName.includes(stopName)) {
                        theoMonthIndex = hardcodedShutdowns[stopName];
                        break;
                    }
                }
            }
            
            if (theoMonthIndex !== -1) {
                monthlyCountsTheo[theoMonthIndex]++;
                lastTheoreticalMonthIndex = Math.max(lastTheoreticalMonthIndex, theoMonthIndex);
            }
        }
    }

    // --- Rendu des r√©sultats
    const pctConformite = totalDDR ? (1 - (enRetard / totalDDR)) * 100 : 0;
    renderKPI_Col(pctConformite, totalDDR - enRetard, totalDDR);

    const pctProgression = totalDDRPlanifie ? (tested / totalDDRPlanifie) * 100 : 0;
    renderKPI_Disc(pctProgression, tested, totalDDRPlanifie);

    // Calcul cumul√© pour la courbe
    const cumPercReal = []; let cumR = 0;
    for (let m = 0; m < 12; m++) { cumR += monthlyCountsReal[m]; cumPercReal[m] = totalDDRPlanifie ? (cumR / totalDDRPlanifie) : 0; }

    const cumPercTheo = []; 
    if (totalDDRPlanifie > 0 && lastTheoreticalMonthIndex !== -1) {
        let cumT = 0;
        for (let m = 0; m <= lastTheoreticalMonthIndex; m++) {
            cumT += monthlyCountsTheo[m];
            cumPercTheo[m] = totalDDRPlanifie ? (cumT / totalDDRPlanifie) : 0;
        }
        const maxTheoValue = cumPercTheo[lastTheoreticalMonthIndex];
        for (let m = lastTheoreticalMonthIndex; m < 12; m++) {
            cumPercTheo[m] = maxTheoValue;
        }
    } else {
        cumPercTheo.fill(0);
    }
    const chartSvg = document.getElementById('advChart');
    const currentMonthIndex = today.getMonth();
    renderLineChart(chartSvg, cumPercReal, cumPercTheo, lastTheoreticalMonthIndex, currentMonthIndex);
}

// ====================================================================
// LOGIQUE DE D√âMARRAGE ET HANDLERS
// ====================================================================

document.addEventListener('DOMContentLoaded', function(){
    const importBtn=document.getElementById('importBtn');
    const prepMainBtn=document.getElementById('prepMainBtn'); 

    // 1. Initialiser le chargement et la souscription
    fetchAndProcessLatestData();
    setupRealtimeSubscription();

    // 2. Lier les actions
    importBtn.onclick = fetchAndProcessLatestData; // Rafra√Æchissement manuel
    prepMainBtn.onclick = openPreparationPage;

    // Suppression des modals d'import (plus n√©cessaires en mode live)
    const configModal=document.getElementById('configModal');
    const closeConfigBtn=document.getElementById('closeBtn');
    closeConfigBtn.onclick=()=>configModal.classList.remove('show');
    
    // Nettoyage de l'√©tat initial
    updateSaveButtonState(false);
    
    // NOTE : La fonction openPreparationPage doit √™tre adapt√©e pour utiliser 
    // le tableau JSON `currentDDRData` au lieu de l'objet Excel `currentWorkbook`.
    async function openPreparationPage(){
        if(!currentDDRData || currentDDRData.length === 0){ showStatusMessage('Aucune donn√©e charg√©e pour la pr√©paration.','error'); return; }

        try{
            // Stocker le tableau JSON directement dans localStorage
            localStorage.setItem('ddr_original_data_json', JSON.stringify(currentDDRData));
            localStorage.setItem('ddr_filename', originalFileName);

            // Ouvrir la nouvelle page (REMPLACEMENT de la page actuelle)
            window.location.href = 'Autre page Test DDR/Pr√©paration Test DDR.html';

            showStatusMessage('Ouverture de la page de pr√©paration.','success');
            
        }catch(e){ 
            showStatusMessage('Erreur lors de la pr√©paration des donn√©es : '+e.message,'error');
        }
    }
    
    // √âcouteur pour la page de pr√©paration: si la page de pr√©pa renvoie un fichier modifi√©,
    // on met √† jour les KPIs SANS recharger Supabase (c'est le r√¥le de la page de pr√©pa de faire la sauvegarde)
    window.addEventListener('storage', (event) => {
        if (event.key === 'ddr_modified_data_json' && event.newValue) {
            try {
                const jsonData = JSON.parse(event.newValue);
                currentDDRData = jsonData;
                
                // Mettre √† jour l'UI et les KPIs avec les nouvelles donn√©es
                processAndRenderJSONData(currentDDRData);
                
                showStatusMessage('Donn√©es mises √† jour depuis la page de pr√©paration.','success');
                
                // Nettoyage : On retire la cl√© de modification apr√®s usage
                localStorage.removeItem('ddr_modified_data_json');

            } catch(error) {
                showStatusMessage('Erreur lors de la lecture des donn√©es modifi√©es : ' + error.message,'error');
            }
        }
    });


    /* ===== Fonctions de Rendu (Inchag√©es) ===== */
    
    function renderKPI_Col(pct, conformes, total){
        const kpiBar=document.getElementById('kpiBar');
        const kpiPct=document.getElementById('kpiPct');
        const kpiRoot=document.getElementById('kpiConformite');
        const p=Math.max(0,Math.min(100,pct));
        kpiPct.textContent=p.toFixed(1).replace('.',',')+' %';
        const h=Math.round(200*(p/100));
        kpiBar.style.height=h+'px';
        if(p<50) kpiBar.style.background='#e74c3c';
        else if(p<80) kpiBar.style.background='#f39c12';
        else kpiBar.style.background='#27ae60';
        kpiBar.title=`${conformes}/${total} √† jour (F ‚â• aujourd‚Äôhui)`;
        kpiRoot.style.display='block';
    }
    function renderKPI_Disc(pct,tested,total){
        const disc=document.getElementById('disc');
        const discPct=document.getElementById('discPct');
        const statTotal=document.getElementById('statTotal');
        const statTested=document.getElementById('statTested');
        const kpiProgRoot=document.getElementById('kpiProgression');
        const p=Math.max(0,Math.min(100,pct));
        disc.style.background=`conic-gradient(#27ae60 ${p*3.6}deg, #e6eef5 0deg)`;
        discPct.textContent=p.toFixed(1).replace('.',',')+' %';
        statTotal.textContent=total; statTested.textContent=tested;
        kpiProgRoot.style.display='block';
    }
    function renderLineChart(svg, cumR, cumT, lastTheoreticalMonthIndex, currentMonthIndex){
        const W=980,H=340, ml=60, mr=20, mt=20, mb=40;
        const innerW=W-ml-mr, innerH=H-mt-mb;
        const months=['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ªt','Sept','Oct','Nov','D√©c'];
        const X = m => (innerW)*(m/11);
        const Y = v => innerH*(1-v);
        
        while(svg.firstChild) svg.removeChild(svg.firstChild);

        const g=document.createElementNS('http://www.w3.org/2000/svg','g');
        g.setAttribute('transform',`translate(${ml},${mt})`);
        svg.appendChild(g);

        for(let i=0;i<=4;i++){
            const y=innerH - (innerH*(i/4));
            const line=document.createElementNS(svg.namespaceURI,'line');
            line.setAttribute('x1',0); line.setAttribute('x2',innerW);
            line.setAttribute('y1',y); line.setAttribute('y2',y);
            line.setAttribute('stroke','#e5ecf3'); line.setAttribute('stroke-width','1');
            g.appendChild(line);

            const lbl=document.createElementNS(svg.namespaceURI,'text');
            lbl.setAttribute('x',-10); lbl.setAttribute('y',y+4);
            lbl.setAttribute('text-anchor','end'); lbl.setAttribute('font-size','11'); lbl.setAttribute('fill','#607d8b');
            lbl.textContent=(i*25)+'%';
            g.appendChild(lbl);
        }
        for(let m=0;m<12;m++){
            const x=(innerW)*(m/11);
            const t=document.createElementNS(svg.namespaceURI,'text');
            t.setAttribute('x',x); t.setAttribute('y',innerH+18);
            t.setAttribute('text-anchor','middle'); t.setAttribute('font-size','11'); t.setAttribute('fill','#607d8b');
            t.textContent=months[m];
            g.appendChild(t);
        }

        function pathFrom(arr, limitIndex){
            let d=''; 
            const actualLimit = Math.min(11, limitIndex); 
            for(let m=0;m<=actualLimit;m++){
                const x=X(m), y=Y(arr[m]); 
                d += (m===0? `M ${x} ${y}`:` L ${x} ${y}`); 
            }
            return d;
        }

        const pTheo=document.createElementNS(svg.namespaceURI,'path');
        pTheo.setAttribute('d',pathFrom(cumT, 11)); 
        pTheo.setAttribute('fill','none'); pTheo.setAttribute('stroke','#3498db');
        pTheo.setAttribute('stroke-width','4'); pTheo.setAttribute('stroke-dasharray','8 4');
        g.appendChild(pTheo);

        const pReal=document.createElementNS(svg.namespaceURI,'path');
        pReal.setAttribute('d',pathFrom(cumR, currentMonthIndex)); 
        pReal.setAttribute('fill','none'); pReal.setAttribute('stroke','#2ecc71'); pReal.setAttribute('stroke-width','4');
        g.appendChild(pReal);

        let lastTheoLabelIndex = -1;
        for(let m=11; m>=0; m--) {
            if (cumT[m] > 0) { lastTheoLabelIndex = m; break; }
        }
        for(let m=0;m<12;m++){
            const cx=X(m), cy=Y(cumT[m]);
            if (cumT[m] > 0) {
                const dot=document.createElementNS(svg.namespaceURI,'circle');
                dot.setAttribute('cx',cx); dot.setAttribute('cy',cy); dot.setAttribute('r',3.5);
                dot.setAttribute('fill','#3498db'); dot.setAttribute('opacity','0.9');
                g.appendChild(dot);
            }
            if (m === lastTheoLabelIndex && cumT[m] > 0) {
                const label=document.createElementNS(svg.namespaceURI,'text');
                label.setAttribute('x',cx); label.setAttribute('y',cy-10);
                label.setAttribute('text-anchor','middle'); label.setAttribute('font-size','12');
                label.setAttribute('font-weight','800'); label.setAttribute('fill','#3498db');
                label.setAttribute('stroke','#fff'); label.setAttribute('stroke-width','3');
                label.setAttribute('paint-order','stroke');
                const pct = (cumT[m]*100).toFixed(1).replace('.',',') + ' %';
                label.textContent = pct;
                g.appendChild(label);
            }
        }
        for(let m=0;m<=currentMonthIndex;m++){
            const cx=X(m), cy=Y(cumR[m]);
            if (cumR[m] > 0) {
                const dot=document.createElementNS(svg.namespaceURI,'circle');
                dot.setAttribute('cx',cx); dot.setAttribute('cy',cy); dot.setAttribute('r',3.5);
                dot.setAttribute('fill','#2ecc71'); dot.setAttribute('opacity','0.9');
                g.appendChild(dot);
            }
            if(m===currentMonthIndex && cumR[m]>0){
                const label=document.createElementNS(svg.namespaceURI,'text');
                label.setAttribute('x',cx); label.setAttribute('y',cy-10);
                label.setAttribute('text-anchor','middle'); label.setAttribute('font-size','12');
                label.setAttribute('font-weight','800'); label.setAttribute('fill','#2c3e50');
                label.setAttribute('stroke','#fff'); label.setAttribute('stroke-width','3');
                label.setAttribute('paint-order','stroke');
                const pct = (cumR[m]*100).toFixed(1).replace('.',',') + ' %';
                label.textContent = pct;
                g.appendChild(label);
            }
        }

        const today=new Date();
        const daysInMonth=new Date(today.getFullYear(), today.getMonth()+1, 0).getDate();
        const frac = today.getMonth() + (today.getDate()-1)/daysInMonth;
        const xToday = X(frac);
        const vLine=document.createElementNS(svg.namespaceURI,'line');
        vLine.setAttribute('x1',xToday); vLine.setAttribute('x2',xToday);
        vLine.setAttribute('y1',0); vLine.setAttribute('y2',innerH);
        vLine.setAttribute('stroke','#3498db'); vLine.setAttribute('stroke-dasharray','6 6');
        vLine.setAttribute('stroke-width','2');
        g.appendChild(vLine);

        const tag=document.createElementNS(svg.namespaceURI,'text');
        tag.setAttribute('x',xToday+6); tag.setAttribute('y',12);
        tag.setAttribute('font-size','12'); tag.setAttribute('fill','#3498db'); tag.setAttribute('font-weight','700');
        tag.textContent="Aujourd'hui";
        g.appendChild(tag);
    }
});
</script>
</body>

</html>