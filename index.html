<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Test DDR</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* VARIABLES COULEURS */
    :root {
      --primary-color: #0078d7; 
      --success-color: #4caf50; 
      --card-bg: white;
      --light-bg: #e0f7fa; 
      --dark-bg: #bbdefb; 
      --shadow-color: rgba(0,0,0,0.15);
      --button-hover: #005bb5;
      
      --preparation-color: #9c27b0; 
      --preparation-hover: #8e24aa; 
    }

    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom right, var(--light-bg), var(--dark-bg)); 
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      margin: 0;
      padding-top: 20px;
    }

    /* HEADER CONNEXION SUPABASE */
    header {
      position: absolute;
      top: 15px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: normal; 
    }
    #dbLabel {
      font-size: 0.8em; 
      margin-right: 5px; 
      color: #666;
    }
    #statusIcon {
      font-size: 0.7em; 
      font-weight: bold; 
      line-height: 1.2; 
    }
    #status {
      display: none; 
    }
    
    /* NOUVEAU STYLE POUR LE BOUTON PREPARATION */
    #top-left-controls {
        position: absolute;
        top: 50px;
        left: 50px;
        /* Caché par défaut, affiché uniquement pour les rôles autorisés par JS */
        display: none; 
    }
    .dashboard-button {
        padding: 20px 40px; 
        font-size: 1.3em; 
        background-color: var(--preparation-color);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3); 
        transition: background-color 0.3s;
    }
    .dashboard-button:hover {
        background-color: var(--preparation-hover);
    }
    /* ---------------- Styles du Tableau de Bord ---------------- */
    #dashboard-title {
        font-size: 2.5em;
        font-weight: bold;
        color: #004d40;
        margin-bottom: 5px; 
    }
    #current-date {
        font-size: 1.2em;
        font-weight: bold;
        color: #004d40;
        margin-bottom: 40px; 
    }
    
    #top-stats {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 50px;
      margin-bottom: 40px;
    }
    
    /* 1. Bloc de Conformité (Barre verticale) */
    #conformite-block {
        text-align: center;
        width: 150px;
    }
    #conformite-value {
        font-size: 2em; 
        font-weight: bold;
        margin-bottom: 10px;
    }
    #conformite-chart-container {
        height: 150px;
        width: 80px;
        margin: 0 auto 10px;
    }

    /* 2. Bloc de Progression (Anneau et Texte) */
    #progression-block {
        display: flex;
        align-items: center;
        gap: 20px;
    }
    #progression-chart-container {
        height: 200px; 
        width: 200px;  
    }
    #progression-text {
        text-align: left;
        padding: 20px;
        background-color: var(--card-bg);
        border-radius: 8px;
        box-shadow: 0 4px 6px var(--shadow-color);
        font-size: 1.1em;
    }
    .data-label {
        color: #333; 
        font-weight: bold; 
    }
    .data-value {
        font-size: 1.4em;
        font-weight: bold;
        color: #333;
    }
    
    /* 3. Graphique d'Évolution (Grand graphique en bas) */
    #evolution-card {
        background-color: var(--card-bg);
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 12px var(--shadow-color);
        width: 800px; 
        max-width: 90%;
    }
    #evolution-chart-container {
        height: 350px;
    }

  </style>
</head>
<body>
  
  <div id="top-left-controls">
    <button onclick="window.location.href='preparation.html'" class="dashboard-button">Préparation</button>
  </div>
    
  <header>
    <span id="dbLabel">Connexion Base de Donnée</span>
    <span id="statusIcon">⏳</span>
  </header>
  <div id="status" style="z-index: 1000; position: fixed; top: 0;">Vérification de la connexion...</div>

  <h1 id="dashboard-title">Test DDR</h1>
  <p id="current-date"></p> <div id="top-stats">
    
    <div id="conformite-block">
        <div id="conformite-value">--,- %</div>
        <div id="conformite-chart-container">
            <canvas id="conformiteChart"></canvas>
        </div>
        <strong>CONFORMITE</strong>
    </div>

    <div id="progression-block">
        <div id="progression-chart-container">
            <canvas id="progressionChart"></canvas>
        </div>
        <div id="progression-text">
            <div id="progression-ring-value" style="font-size: 1.6em; font-weight: bold; color: #333; margin-bottom: 5px;">PROGRESSION</div>
            <p>
                <span class="data-label">DDR Répertorié :</span>
                <span class="data-value" id="totalPlanifie">----</span>
            </p>
            <p style="margin-top: 5px;">
                <span class="data-label">DDR Testé :</span>
                <span class="data-value" id="totalTestes">----</span>
            </p>
        </div>
    </div>
  </div>

  <div id="evolution-card">
      <div id="evolution-chart-container">
          <canvas id="evolutionChart"></canvas>
      </div>
  </div>

  <script type="module">
    // ----------------------------------------------------------------------------------
    // FONCTION POUR AFFICHER LA DATE
    // ----------------------------------------------------------------------------------
    function displayCurrentDate() {
        const dateElement = document.getElementById('current-date');
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const today = new Date();
        // Affichage de la date formatée en français
        dateElement.textContent = today.toLocaleDateString('fr-FR', options);
    }

    // ----------------------------------------------------------------------------------
    // 1. Initialisation Supabase & Logique de Sécurité (checkAuthAndRole)
    // ----------------------------------------------------------------------------------
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    
    const SUPABASE_URL = 'https://ejirdcqcmmeybgitonmw.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqaXJkY3FjbW1leWJnaXRvbm13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1OTY2MjYsImV4cCI6MjA3NzE3MjYyNn0.4E93ufwJ-RIjV9qT0I4t3GiI9NIzVzN_ktwDPswT7ic'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    
    /**
     * NOUVELLE LOGIQUE DE SÉCURITÉ : Vérifie la connexion, le rôle et adapte l'UI.
     */
    async function checkAuthAndRole() {
        displayCurrentDate(); 

        const icon = document.getElementById('statusIcon')
        const label = document.getElementById('dbLabel')
        const status = document.getElementById('status')

        // 1. VÉRIFICATION DE LA SESSION UTILISATEUR
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();

        if (!session || sessionError) {
            // REDIRECTION CRITIQUE : L'utilisateur n'est pas logué
            window.location.href = '/login.html'; 
            return; 
        }

        // 2. VÉRIFICATION DU RÔLE (AUTORISATION)
        try {
            // CORRECTION CRITIQUE : Utilisation des GUILLEMETS DOUBLES pour le nom de table avec espace
            const { data: profile, error: roleError } = await supabase
                .from('"utilisateur autorisation"') // <--- CORRECTION APPLIQUÉE
                .select('role')
                .eq('user_id', session.user.id)
                .single();

            if (roleError || !profile) {
                console.error("Erreur de récupération du profil ou rôle manquant. Déconnexion forcée.", roleError);
                await supabase.auth.signOut();
                window.location.href = '/login.html';
                return;
            }

            const userRole = profile.role;

            // Contrôle du Front-end : Afficher le bouton si le rôle est suffisant
            if (userRole === 'admin' || userRole === 'preparator') {
                 document.getElementById('top-left-controls').style.display = 'block'; 
            }

            // Met à jour le statut de connexion BD (visuel)
            status.textContent = '' 
            status.style.backgroundColor = 'transparent'
            icon.textContent = '✓' 
            icon.style.color = 'green'
            label.style.color = 'green'

            // Lance l'initialisation des graphiques (le site est chargé et autorisé)
            await initCharts(); 

        } catch (e) {
            console.error("Erreur critique d'accès à la BD ou de vérification:", e);
            
            // LOGIQUE DE SECOURS (FALLBACK) EN CAS D'ÉCHEC DE CONNEXION À LA BD
            status.textContent = '❌ Erreur de connexion aux données'
            status.style.backgroundColor = '#ffdddd'
            icon.textContent = '✕' 
            icon.style.color = 'red'
            label.style.color = 'red'
            
            // Utilise les valeurs de secours pour afficher le tableau de bord
            const fallbackTheoretical = Array(12).fill(0); 
            const fallbackReal = [
                5, 15, 28, 32, 80, 82, 82, 82, 82, 87, null, null 
            ];
            const evolutionDataFallback = fallbackReal.map((real, index) => ({
                month: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sept', 'Oct', 'Nov', 'Déc'][index],
                real: real, 
                theoretical: fallbackTheoretical[index]
            }));
            renderCharts(86.7, 85.5, 3434, 2935, evolutionDataFallback);
        }
    }


    // ----------------------------------------------------------------------------------
    // 2. Fonctions de Récupération des Données (fetchConformiteData et fetchEvolutionData)
    // ----------------------------------------------------------------------------------
    
    async function fetchConformiteData() {
        const currentYear = new Date().getFullYear();
        const startOfYear = `${currentYear}-01-01`;
        const endOfYear = `${currentYear}-12-31`;

        const { count: totalDDR, error: totalError } = await supabase
            .from('liste_ddr')
            .select('*', { count: 'exact', head: true });

        const { count: expiredDDR, error: expiredError } = await supabase
            .from('liste_ddr')
            .select('*', { count: 'exact', head: true })
            .lt('Date prochain controle', new Date().toISOString().split('T')[0]); 

        const { count: ddrThisYear, error: ddrThisYearError } = await supabase
            .from('liste_ddr')
            .select('*', { count: 'exact', head: true })
            .gte('Date prochain controle', startOfYear) 
            .lte('Date prochain controle', endOfYear); 

        if (totalError || expiredError || ddrThisYearError || totalDDR === null || expiredDDR === null || ddrThisYear === null) {
            console.error('Erreur lors de la récupération des données de DDR:', totalError || expiredError || ddrThisYearError);
            return null; 
        }

        if (totalDDR === 0) {
            return { conformite: 100, progression: 0, totalDDR: 0, ddrThisYear: 0 };
        }

        const nonConformiteRate = (expiredDDR / totalDDR) * 100;
        const conformiteRate = 100 - nonConformiteRate;
        
        const progressionRate = (ddrThisYear / totalDDR) * 100;

        return { 
            conformite: conformiteRate,
            progression: progressionRate,
            totalDDR: totalDDR, 
            ddrThisYear: ddrThisYear 
        };
    }
    
    async function fetchEvolutionData(totalDDR) {
        if (totalDDR === 0) {
            return Array(12).fill(0).map((_, index) => ({ 
                month: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sept', 'Oct', 'Nov', 'Déc'][index],
                real: 0, 
                theoretical: 0 
            }));
        }

        const todayDate = new Date();
        const currentYear = todayDate.getFullYear();
        const currentMonth = todayDate.getMonth() + 1; 
        const startOfYear = `${currentYear}-01-01`;

        const evolutionData = [];
        
        for (let month = 1; month <= 12; month++) {
            const monthLabel = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sept', 'Oct', 'Nov', 'Déc'][month - 1];
            let realPercentage = null; 
            let theoreticalPercentage = 0;
            
            const plannedEndDateFilter = new Date(currentYear, month, 0).toISOString().split('T')[0];
            const { count: plannedUpToMonth, error: plannedError } = await supabase
                .from('liste_ddr')
                .select('*', { count: 'exact', head: true })
                .lte('Date planifiee', plannedEndDateFilter)
                .gte('Date planifiee', startOfYear); 

            if (!plannedError) {
                theoreticalPercentage = (plannedUpToMonth || 0) / totalDDR * 100;
            }

            if (month <= currentMonth) {
                let realEndDateFilter;
                if (month === currentMonth) {
                    realEndDateFilter = todayDate.toISOString().split('T')[0];
                } else {
                    realEndDateFilter = plannedEndDateFilter; 
                }

                const { count: testedUpToMonth, error: realError } = await supabase
                    .from('liste_ddr')
                    .select('*', { count: 'exact', head: true })
                    .lte('Date de dernier controle', realEndDateFilter)
                    .gte('Date de dernier controle', startOfYear); 

                if (!realError) {
                    realPercentage = (testedUpToMonth || 0) / totalDDR * 100;
                }
            }
            
            evolutionData.push({ 
                month: monthLabel,
                real: realPercentage, 
                theoretical: theoreticalPercentage 
            });
        }

        return evolutionData;
    }
    
    // ----------------------------------------------------------------------------------
    // 3. Fonction Principale d'Initialisation (initCharts)
    // ----------------------------------------------------------------------------------

    async function initCharts() {
        const conformiteData = await fetchConformiteData();
        
        const conformite = conformiteData ? conformiteData.conformite : 86.7; 
        const progression = conformiteData ? conformiteData.progression : 85.5; 
        const totalPlanifie = conformiteData ? conformiteData.totalDDR : 3434; 
        const ddrThisYear = conformiteData ? conformiteData.ddrThisYear : 2935; 
        
        const evolutionData = conformiteData 
            ? await fetchEvolutionData(conformiteData.totalDDR) 
            : null;

        const fallbackTheoretical = Array(12).fill(0); 
        const fallbackReal = [
            5, 15, 28, 32, 80, 82, 82, 82, 82, 87, null, null
        ];
        
        const evolutionDataFallback = fallbackReal.map((real, index) => ({
            month: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sept', 'Oct', 'Nov', 'Déc'][index],
            real: real, 
            theoretical: fallbackTheoretical[index]
        }));
        
        renderCharts(conformite, progression, totalPlanifie, ddrThisYear, evolutionData || evolutionDataFallback);
    }

    // ----------------------------------------------------------------------------------
    // 4. Fonction de Rendu (renderCharts)
    // ----------------------------------------------------------------------------------

    function renderCharts(conformite, progression, totalPlanifie, ddrThisYear, evolutionData) {
        // COULEURS DU THÈME
        const successColor = '#4caf50'; // Vert
        const primaryColor = '#0078d7'; // Bleu
        const greyColor = '#e0e0e0';
        
        // Mise à jour des valeurs textuelles
        document.getElementById('conformite-value').textContent = conformite.toFixed(1).replace('.', ',') + ' %';
        document.getElementById('totalPlanifie').textContent = totalPlanifie; 
        document.getElementById('totalTestes').textContent = ddrThisYear; 


        // 1. Graphique de Conformité
        const conformiteCtx = document.getElementById('conformiteChart').getContext('2d');
        if (Chart.getChart(conformiteCtx)) Chart.getChart(conformiteCtx).destroy();
        new Chart(conformiteCtx, {
            type: 'bar',
            data: {
                labels: [''],
                datasets: [
                    {
                        label: 'Manquant',
                        data: [100 - conformite],
                        backgroundColor: greyColor, 
                        borderRadius: 10,
                    },
                    {
                        label: 'Conformité',
                        data: [conformite],
                        backgroundColor: successColor, 
                        borderWidth: 2,
                        borderRadius: 10,
                    }
                ]
            },
            options: {
                responsive: true, 
                maintainAspectRatio: false,
                scales: { 
                    x: { display: false, stacked: true }, 
                    y: { display: false, stacked: true, max: 100, reverse: true } 
                },
                plugins: { legend: { display: false }, tooltip: { enabled: false } }
            }
        });


        // 2. Graphique de Progression (Anneau)
        const progressionCtx = document.getElementById('progressionChart').getContext('2d');
        if (Chart.getChart(progressionCtx)) Chart.getChart(progressionCtx).destroy();
        new Chart(progressionCtx, {
            type: 'doughnut',
            data: {
                labels: ['Prévus cette année', 'Hors année'],
                datasets: [{
                    data: [progression, 100 - progression],
                    backgroundColor: [successColor, greyColor], 
                    borderWidth: 0,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, cutout: '70%', 
                plugins: { legend: { display: false }, tooltip: { enabled: false } }
            },
            plugins: [{
                id: 'textCenter',
                beforeDatasetsDraw(chart, args, pluginOptions) {
                    const { ctx, data, chartArea: { top, width, height } } = chart;
                    ctx.save();
                    ctx.font = 'bolder 2em Arial'; 
                    ctx.fillStyle = '#333'; 
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(data.datasets[0].data[0].toFixed(1).replace('.', ',') + ' %', width / 2, height / 2 + top);
                    ctx.restore();
                }
            }]
        });


        // 3. Graphique d'Évolution (Ligne)
        const evolutionCtx = document.getElementById('evolutionChart').getContext('2d');
        if (Chart.getChart(evolutionCtx)) Chart.getChart(evolutionCtx).destroy();
        new Chart(evolutionCtx, {
            type: 'line',
            data: {
                labels: evolutionData.map(d => d.month),
                datasets: [
                    {
                        label: 'Progression réelle',
                        data: evolutionData.map(d => d.real), 
                        borderColor: successColor, backgroundColor: 'transparent',
                        tension: 0.2, pointRadius: 3, borderWidth: 3
                    },
                    {
                        label: 'Progression théorique',
                        data: evolutionData.map(d => d.theoretical), 
                        borderColor: primaryColor, backgroundColor: 'transparent',
                        borderDash: [5, 5], tension: 0.2, pointRadius: 0, borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top', labels: { usePointStyle: true, } },
                    tooltip: {
                        mode: 'index', intersect: false,
                        callbacks: { 
                            label: (context) => context.dataset.label + ': ' + (context.parsed.y !== null ? context.parsed.y.toFixed(1).replace('.', ',') + ' %' : 'N/A') 
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true, max: 100, title: { display: false }, ticks: { callback: (value) => value + ' %' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    // DÉCLENCHE LA NOUVELLE LOGIQUE DE SÉCURITÉ AU DÉMARRAGE
    checkAuthAndRole(); // <--- NOUVEL APPEL SÉCURISÉ
  </script>
</body>
</html>